---
title: "2.lib和sub函数"
lastmod: 2023-08-28T16:00:05+08:00
date: 2023-08-28T16:00:05+08:00
tags: [""]
categories: ["BDL"]
weight: 2
# bookFlatSection: false
# bookToc: true
# bookHidden: false
# bookCollapseSection: false
# bookComments: false
# bookSearchExclude: false
---

# lib 和 sub 函数

## 42x 文件

回顾上一节的练习，调用`cl_null()`函数，是不是比较简单。

但是我们来看下一下`p_zz.4gl`的源码中调用了多少次 lib 函数(lib 函数一般以`cl`开始，有误差，但误差不大)，`$AZZ/4gl`目录下。

```bash
cd $AZZ/4gl
grep -c "cl" p_zz.4gl
...
265
```

调用了 265 次 lib 函数，如果按照上一节的办法，我们要找到这 265 个 lib 函数对应的文件，链接后并编译。

这实在太不方便了，所以 BDL 在链接时其实还隐藏了一个功能。

不需要额外的命令和源代码，我们依然使用`czzi004.4gl`和`s_czzi004.4gl`进行示例。

我们先删除之前生成的文件，防止影响本次结果。

```bash
cd $CZZ/4gl
rm *czzi004*.42m
rm *czzi004*.42r
```

1. 编译 `czzi004.4gl`和`s_czzi004.4gl`，和之前一样

2. 单独链接 `s_czzi004.42m`

```bash
fgllink -o czzi004_sub.42x s_czzi004.42m
```

3. 编译 `czzi004_sub.42x`和`czzi004.42m`

```bash
fgllink -o czzi004.42r czzi004.42m czzi004_sub.42x
```

4. `fglrun czzi004`

一样可以运行，看起来并没有减少步骤。

但是我们可以将第二步运用到整个 lib 目录下的所有文件，将所有 lib 目录下源代码都链接为`lib.42x`文件，那么之后不管哪个作业调用多少个 lib 函数，那么我们只要在编译这个新作业后，将`lib.42x`这个文件和主程序链接以下即可。

只要当`lib`目录下哪个文件修改了，才需要重新连接`lib.42x`文件。

这一步`tiptop gp`已经替我们做好了，`$LIB/42m`目录下有一个`lib.42x`文件。

上一节的练习题中，让我们使用以下命令，连接主程序。

```bash
fgllink -o czzi004.42r czzi004.42m $LIB/42m/lib.42x
```

结果一样可以运行。

## lib 和 sub 函数

`lib`和`sub`是`tiptop gp`中的两个子函数库，如果你使用`r.l2`链接程序，那么程序自动将这两个函数库链接到程序中。

所以这两个库的函数，你可以随时调用，而不用担心函数不存在的报错。

在结构上`lib`和`sub`没有任何区别，在使用上没有任何区别。

但如果你要新增，或者修改那么有几点需要注意：

|     项目 | lib                                                    | sub                                |
| -------: | :----------------------------------------------------- | :--------------------------------- |
| 功能范围 | 底层逻辑(替换字符串、判断字符段是否为空、四舍五入函数) | 业务逻辑（库存过账、系统日志记录） |
| 建议新增 | 不建议                                                 | 可以                               |
| 建议修改 | 不建议                                                 | 可以                               |
| 建议删除 | 不建议                                                 | 不建议                             |

{{< hint danger >}}
**重要**

无论是 sub 还是 lib，链接失败都影响所有作业，如果你要修改或新增这两个库的函数，请**务必**现在测试区测试成功后再搬到正式区运行。
{{</ hint >}}

